<?php
/**
 * Template Name: メニュー一覧管理画面
 */
get_header();
?>


<?php
// カスタムクエリでメニュー投稿を取得
$args = array(
    'post_type' => 'post',
    'post_status' => 'publish',
    'posts_per_page' => -1,
    'orderby' => 'meta_value',
    'meta_key' => 'menu_no',
    'order' => 'ASC',
    'meta_query' => array(
        array(
            'key' => 'menu_no',
            'compare' => 'EXISTS'
        )
    )
);

$menu_query = new WP_Query($args);

if ($menu_query->have_posts()) :
    echo '<div class="menu-list">';
    echo '<h3>登録メニュー一覧 (' . $menu_query->found_posts . '件)</h3>';
    echo '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
    echo '<thead><tr style="background: #333; color: white;">';
    echo '<th style="padding: 10px; border: 1px solid #ddd;">MENU番号</th>';
    echo '<th style="padding: 10px; border: 1px solid #ddd;">タイトル</th>';
    echo '<th style="padding: 10px; border: 1px solid #ddd;">アクション</th>';
    echo '</tr></thead>';
    echo '<tbody>';
    
    while ($menu_query->have_posts()) : $menu_query->the_post();
        $menu_no = get_post_meta(get_the_ID(), 'menu_no', true);
        $end_date = get_post_meta(get_the_ID(), 'end_date', true);
        if (empty($end_date)) {
            $end_date = get_post_meta(get_the_ID(), '掲載終了日', true);
        }
        
        echo '<tr style="border: 1px solid #ddd;">';
        echo '<td style="padding: 10px; border: 1px solid #ddd;">' . esc_html($menu_no ?: '未設定') . '</td>';
        echo '<td style="padding: 10px; border: 1px solid #ddd;">';
        echo '<strong>' . get_the_title() . '</strong>';
        if ($end_date) {
            echo '<br><small>掲載終了: ' . esc_html($end_date) . '</small>';
        }
        echo '</td>';
        echo '<td style="padding: 10px; border: 1px solid #ddd;">';
        echo '<a href="?menu_number=' . urlencode($menu_no) . '" style="color: #007cba; text-decoration: none;">詳細</a>';
        echo '</td>';
        echo '</tr>';
    endwhile;
    
    echo '</tbody></table>';
    echo '</div>';
    wp_reset_postdata();
else :
    echo '<div style="background: #fff3cd; padding: 20px; border-radius: 5px; border-left: 4px solid #ffc107;">';
    echo '<h3>メニューがありません</h3>';
    echo '<p>以下の可能性があります：</p>';
    echo '<ul>';
    echo '<li>投稿が公開されていない</li>';
    echo '<li>menu_noカスタムフィールドが設定されていない</li>';
    echo '<li>投稿が存在しない</li>';
    echo '</ul>';
    echo '<p><a href="/wp-admin/post-new.php" target="_blank">新規投稿を作成</a></p>';
    echo '</div>';
endif;
?>

<style>
.menu-list table {
    margin-top: 20px;
}
.menu-list tr:nth-child(even) {
    background: #f9f9f9;
}
.menu-list tr:hover {
    background: #f0f8ff;
}
</style>

<?php
get_footer();